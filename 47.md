NIP-47
======

Nostr Wallet Connect
------------------------

`draft` `optional` `author:kiwiidb` `author:bumi` `author:vitorpamplona`

## Rationale

Paying Zaps should be possible without the user needing to open a different app to only pay a Lightning invoice.
This NIP describes a way for users to control a remote Lightning node or a custodial Lightning wallet. When self-hosting, this setup does not require the user to run their own server, thereby bypassing certain hurdles that are commonly encountered when trying to connect to a Lightning node remotely.

## Terms

* **client**: Nostr app on any platform that wants to pay Lightning invoices
* **nostr-wallet-connect-service**: Nostr app that typically runs on an always-on computer (eg. in the cloud or on a Raspberry Pi).

## `TL;DR`

**client** and **nostr-wallet-connect-service** sends ephemeral encrypted messages with custom kinds to each other, using a relay of choice. 

- `NIP_47_REQUEST_KIND`: 23194. Content should be a bolt11 invoice.
- `NIP_47_SUCCESS_RESPONSE_KIND`: 23195. Content should be the preimage of the succesful payment.
- `NIP_47_ERROR_RESPONSE_KIND`: 23196. Content should be an error message.

**client** prompts the **nostr-wallet-connect-service** to pay invoices.

### Nostr Connect URI
We will re-use the connection URI from NIP-46.
**client** discovers **nostr-wallet-connect-service** by scanning a QR code, clicking on a deep link or copy-pasting an URI.

The **nostr-wallet-connect-service** generates a special URI with prefix `nostrwalletconnect://` and base path it's hex-encoded `pubkey` with the following querystring parameters **URL encoded**

**client** should then store this connection and use it when the user wants to pay bolt11 invoices later.

- `relay` URL of the relay of choice where the **nostr-wallet-connect-app** is connected and the **nostr-wallet-connect-app** must send and listen for messages.
- `metadata`  metadata JSON of the **nostr-wallet-connect-app** 
    - `name` human-readable name of the **nostr-wallet-connect-app** 
    - `url` (optional) URL of the website requesting the connection
    - `description` (optional) description of the **nostr-wallet-connect-app**
    - `icons` (optional) array of URLs for icons of the **nostr-wallet-connect-app**.

#### JavaScript

```js
const uri = `nostrwalletconnect://<pubkey>?relay=${encodeURIComponent("wss://relay.damus.io")}&metadata=${encodeURIComponent(JSON.stringify({"name": "Example"}))}`
```

#### Example
```sh
nostrwalletconnect://b889ff5b1513b641e2a139f661a661364979c5beee91842f8f0ef42ab558e9d4?relay=wss%3A%2F%2Frelay.damus.io&metadata=%7B%22name%22%3A%22Example%22%7D
```

## Pay invoice flow
The `content` field **always** contains an *encrypted* message as specified by [NIP04](https://github.com/nostr-protocol/nips/blob/master/04.md).
0. The user authorizes a public key with **nostr-wallet-connect-service** to to perform payments. For example, they add their key in a dashboard of a custodial service, or add their key in the dashboard of an Umbrel app.
1. **client** sends an event to with **nostr-wallet-connect-service** service with kind 23194. The content is a bolt11 invoice.
2. **nostr-wallet-connect-service** verifies that the **client**'s key is authorized to perform the payment, decrypts the payload and sends the payment.
3. **nostr-wallet-connect-service** responds to the event by sending an event with the content being the preimage of the payment or an error message.